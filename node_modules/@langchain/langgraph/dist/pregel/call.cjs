"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.call = exports.getRunnableForEntrypoint = exports.getRunnableForFunc = void 0;
const runnables_1 = require("@langchain/core/runnables");
const singletons_1 = require("@langchain/core/singletons");
const constants_js_1 = require("../constants.cjs");
const write_js_1 = require("./write.cjs");
const utils_js_1 = require("../utils.cjs");
const types_js_1 = require("../func/types.cjs");
/**
 * Wraps a user function in a Runnable that writes the returned value to the RETURN channel.
 */
function getRunnableForFunc(name, func) {
    const run = new utils_js_1.RunnableCallable({
        func: (input) => func(...input),
        name,
        trace: false,
        recurse: false,
    });
    return new runnables_1.RunnableSequence({
        name,
        first: run,
        last: new write_js_1.ChannelWrite([{ channel: constants_js_1.RETURN, value: write_js_1.PASSTHROUGH }], [constants_js_1.TAG_HIDDEN]),
    });
}
exports.getRunnableForFunc = getRunnableForFunc;
function getRunnableForEntrypoint(name, func) {
    const run = new utils_js_1.RunnableCallable({
        func: (input, config) => {
            return func(input, config);
        },
        name,
        trace: false,
        recurse: false,
    });
    return new runnables_1.RunnableSequence({
        name,
        first: run,
        middle: [
            new write_js_1.ChannelWrite([
                {
                    channel: constants_js_1.END,
                    value: write_js_1.PASSTHROUGH,
                    mapper: new utils_js_1.RunnableCallable({
                        func: (value) => ((0, types_js_1.isEntrypointFinal)(value) ? value.value : value),
                    }),
                },
            ], [constants_js_1.TAG_HIDDEN]),
            new write_js_1.ChannelWrite([
                {
                    channel: constants_js_1.PREVIOUS,
                    value: write_js_1.PASSTHROUGH,
                    mapper: new utils_js_1.RunnableCallable({
                        func: (value) => {
                            return (0, types_js_1.isEntrypointFinal)(value) ? value.save : value;
                        },
                    }),
                },
            ]),
        ],
        last: new utils_js_1.RunnableCallable({
            func: (final) => (0, types_js_1.isEntrypointFinal)(final) ? final.value : final,
        }),
    });
}
exports.getRunnableForEntrypoint = getRunnableForEntrypoint;
function call({ func, name, retry }, ...args) {
    const config = singletons_1.AsyncLocalStorageProviderSingleton.getRunnableConfig();
    if (typeof config.configurable?.[constants_js_1.CONFIG_KEY_CALL] === "function") {
        return config.configurable[constants_js_1.CONFIG_KEY_CALL](func, name, args, {
            retry,
            callbacks: config.callbacks,
        });
    }
    throw new Error("Async local storage not initialized. Please call initializeAsyncLocalStorageSingleton() before using this function.");
}
exports.call = call;
//# sourceMappingURL=call.js.map